<!-- 地图页面V2 -->
<view class="container">
  <!-- 遮罩层，点击时折叠筛选器 -->
  <view class="mask" wx:if="{{filterExpanded && hasFilters}}" bindtap="toggleFilter" catchtouchmove="preventTouchMove"></view>
  
  <!-- 第一个区域：顶部信息栏和筛选器，默认高度10vh -->
  <view class="header-section {{filterExpanded ? 'expanded' : ''}}">
    <view class="header-bar">
      <text class="header-title">{{mapData.name}}</text>
      <view class="expand-btn" bindtap="toggleFilter" wx:if="{{hasFilters}}">
        <t-icon name="{{filterExpanded ? 'chevron-up' : 'chevron-down'}}" size="48rpx" />
      </view>
    </view>
    
    <!-- 筛选器区域，展开/折叠 -->
    <view class="filter-container" wx:if="{{filterExpanded && hasFilters}}" catchtap="preventBubble">
      <!-- Inclusive筛选器（默认全选，至少选一个） -->
      <block wx:for="{{filterCategories.inclusive}}" wx:key="index" wx:for-item="category">
        <view class="filter-category">
          <view class="filter-row">
            <text class="filter-category-title">{{category}}：</text>
            <view class="filter-list">
              <view 
                wx:for="{{filterValues.inclusive[category]}}" 
                wx:key="index"
                class="filter-item inclusive {{filterState.inclusive[category][item] ? 'active' : ''}}"
                bindtap="onInclusiveFilterTap"
                data-category="{{category}}"
                data-value="{{item}}"
              >
                {{item}}
              </view>
            </view>
          </view>
        </view>
      </block>
      
      <!-- Exclusive筛选器（默认全不选，至多选一个） -->
      <block wx:for="{{filterCategories.exclusive}}" wx:key="index" wx:for-item="category">
        <view class="filter-category">
          <view class="filter-row">
            <text class="filter-category-title">{{category}}：</text>
            <view class="filter-list">
              <view 
                wx:for="{{filterValues.exclusive[category]}}" 
                wx:key="index"
                class="filter-item exclusive {{filterState.exclusive[category][item] ? 'active' : ''}}"
                bindtap="onExclusiveFilterTap"
                data-category="{{category}}"
                data-value="{{item}}"
              >
                {{item}}
              </view>
            </view>
          </view>
        </view>
      </block>
      
      <!-- 重置按钮 -->
      <view class="filter-reset-btn" bindtap="resetFilters">
        <text>重置筛选</text>
      </view>
    </view>
  </view>
  
  <!-- 第二个区域：地图和列表双Tab，默认高度45vh -->
  <view class="content-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange" t-class="custom-tabs" swipeable="{{false}}">
      <t-tab-panel label="地图" value="map">
        <view class="map-container" >
          <map
            id="myMap"
            latitude="{{latitude}}"
            longitude="{{longitude}}"
            scale="{{scale}}"
            min-scale="{{minScale}}"
            max-scale="{{maxScale}}"
            markers="{{markers}}"
            polyline="{{polyline}}"
            bindregionchange="regionChange"
            bindmarkertap="markerTap"
            show-location="{{false}}"
          ></map>
          
          <!-- 加载状态 -->
          <view class="loading-container" wx:if="{{loading}}">
            <t-loading theme="circular" size="48rpx" loading />
            <text class="loading-text">加载中...</text>
          </view>
          
          <!-- 地图控制按钮 -->
          <view class="map-controls">
            <button class="map-control-btn" size="mini" bindtap="resetMap">重置</button>
            
            <!-- 缩放控制按钮 -->
            <view class="zoom-controls">
              <button class="map-control-btn" size="mini" bindtap="setScale" data-scale="{{currentScale - 1}}">-</button>
              <text class="zoom-text">缩放:{{currentScale}}</text>
              <button class="map-control-btn" size="mini" bindtap="setScale" data-scale="{{currentScale + 1}}">+</button>
            </view>
          </view>
        </view>
      </t-tab-panel>
      
      <t-tab-panel label="列表" value="list">
        <!-- 聚合点列表 -->
        <scroll-view wx:if="{{clusterListVisible}}" scroll-y class="points-list cluster-list" scroll-into-view="{{scrollIntoClusterView}}" scroll-with-animation="{{false}}">
          <view class="cluster-header">
            <view class="cluster-title">包含 {{clusterPoints.length}} 个位置</view>
            <view class="cluster-exit-btn" bindtap="exitClusterSelection">
              <t-icon name="close" size="32rpx" />
              <text>返回</text>
            </view>
          </view>
          <view 
            wx:for="{{clusterPoints}}" 
            wx:key="index"
            id="cluster-point-{{item.index}}"
            class="point-item cluster-item {{selectedPointIndex === item.index ? 'active' : ''}}"
            bindtap="selectClusterPoint"
            data-index="{{index}}"
            data-point-id="{{item.index}}"
          >
            <view class="point-name">
              <text class="point-index">{{item.index}}.</text> {{item.name}}
            </view>
          </view>
        </scroll-view>
        
        <!-- 普通点位列表 -->
        <scroll-view wx:else scroll-y class="points-list" scroll-into-view="{{scrollIntoView}}" scroll-with-animation="{{false}}">
          <view 
            wx:for="{{mapData.points || []}}" 
            wx:key="index"
            id="point-{{item.index}}"
            class="point-item {{selectedPointIndex === item.index ? 'active' : ''}}"
            bindtap="selectPoint"
            data-index="{{index}}"
          >
            <view class="point-name">
              <text class="point-index">{{item.index}}.</text> {{item.name}}
            </view>
            <!-- 显示标签 -->
            <view class="point-tags" wx:if="{{item.tags && item.tags.length > 0}}">
              <text wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag" class="point-tag">{{tag}}</text>
            </view>
          </view>
          <view wx:if="{{!mapData.points || mapData.points.length === 0}}" class="empty-list">
            <text>暂无点位数据</text>
          </view>
        </scroll-view>
      </t-tab-panel>
    </t-tabs>
  </view>
  
  <!-- 第三个区域：点位详情 -->
  <view class="detail-section">
    <view class="detail-container" wx:if="{{selectedPoint}}">
      <view class="detail-header">
        <text class="detail-title">{{selectedPoint.name}}</text>
      </view>
      
      <view class="detail-content">
        <view class="detail-item" wx:if="{{selectedPoint.address}}">
          <t-icon name="location" size="22" />
          <text class="detail-text clickable" bindtap="copyText" data-text="{{selectedPoint.address}}">{{selectedPoint.address}}</text>
        </view>
        
        <view class="detail-item" wx:if="{{selectedPoint.phone}}">
          <t-icon name="call" size="22" />
          <text class="detail-text clickable" bindtap="copyText" data-text="{{selectedPoint.phone}}">{{selectedPoint.phone}}</text>
        </view>
        
        <view class="detail-item" wx:if="{{selectedPoint.webName}}">
          <t-icon name="link" size="22" />
          <text class="detail-text clickable" bindtap="copyText" data-text="{{selectedPoint.webName}}">{{selectedPoint.webName}}</text>
        </view>
        
        <!-- 显示标签 -->
        <view class="detail-tags" wx:if="{{selectedPoint.tags && selectedPoint.tags.length > 0}}">
          <text wx:for="{{selectedPoint.tags}}" wx:key="*this" class="detail-tag">{{item}}</text>
        </view>
        
        <view class="detail-intro" wx:if="{{selectedPoint.intro}}">
          <text>{{selectedPoint.intro}}</text>
        </view>
        
        <!-- 导航按钮 -->
        <view class="navigation-container">
          <view class="navigation-pill" bindtap="navigateToLocation">
            <t-icon name="navigate" size="22" />
            <text>导航</text>
          </view>
        </view>
        
      </view>
    </view>
    
    <view class="empty-detail" wx:else>
      <text>请选择一个点位查看详情</text>
    </view>
  </view>
</view> 